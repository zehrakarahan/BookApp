@{
    ViewData["Title"] = "Excel Yükle";
}

<h2>Excel Yükle</h2>

<!-- Excel dosyasını yükleme formu -->
<form id="uploadExcelForm" enctype="multipart/form-data">
    <div class="form-group">
        <label for="excelFile">Excel Dosyası Yükle</label>
        <input type="file" class="form-control-file" id="excelFile" name="excelFile" />
    </div>
    <button type="submit" class="btn btn-success">Yükle</button>
</form>

<!-- Sonuç mesajını göstermek için bir div -->
<div id="resultMessage"></div>

<!-- Password Policy gösterim alanı -->
<h2>Password Policy</h2>
<div id="passwordPolicy">
    <p>Require Digit: <span id="requireDigit"></span></p>
    <p>Require LowerCase: <span id="requireLowerCase"></span></p>
    <p>Require UpperCase: <span id="requireUpperCase"></span></p>
    <p>Require Non-Alphanumeric: <span id="requireNonAlphanumeric"></span></p>
    <p>Required Length: <span id="requiredLength"></span></p>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script>
        $(document).ready(function () {
            // Password Policy'yi almak için AJAX isteği
            $.ajax({
                url: baseUrl + 'api/auth/GetPasswordPolicy',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer @ViewData["Token"]'
                },
                success: function (response) {
                    $('#requireDigit').text(response.requireDigit ? 'Evet' : 'Hayır');
                    $('#requireLowerCase').text(response.requireLowerCase ? 'Evet' : 'Hayır');
                    $('#requireUpperCase').text(response.requireUpperCase ? 'Evet' : 'Hayır');
                    $('#requireNonAlphanumeric').text(response.requireNonAlphanumeric ? 'Evet' : 'Hayır');
                    $('#requiredLength').text(response.requiredLength);
                },
                error: function (xhr, status, error) {
                    $('#passwordPolicy').html('<div class="alert alert-danger">Password Policy bilgisi alınırken bir hata oluştu: ' + error + '</div>');
                }
            });

            $('#uploadExcelForm').on('submit', function (event) {
                event.preventDefault();
                var formData = new FormData();
                var fileInput = $('#excelFile')[0];

                if (fileInput.files.length === 0) {
                    alert('Lütfen bir dosya seçin.');
                    return;
                }

                formData.append('excelFile', fileInput.files[0]);

                var reader = new FileReader();
                reader.onload = function (e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    jsonData.shift();
                    var users = jsonData.map(function (row) {
                        return {
                            FullName: row[0],
                            Email: row[1],
                            Password: row[2],
                            PasswordConfirm: row[3]
                        };
                    });

                    var request = { Users: users };

                    $.ajax({
                        url: baseUrl + 'api/Auth/RegisterRange',
                        type: 'POST',
                        headers: {
                            'Authorization': 'Bearer @ViewData["Token"]'
                        },
                        data: JSON.stringify(request),
                        contentType: 'application/json',
                        processData: false,
                        success: function (response) {
                            $('#resultMessage').html('<div class="alert alert-success">Kullanıcılar başarıyla eklendi.</div>');
                        },
                        error: function (xhr, status, error) {
                            $('#resultMessage').html('<div class="alert alert-danger">Dosya yüklenirken bir hata oluştu: ' + error + '</div>');
                        }
                    });
                };
                reader.readAsArrayBuffer(fileInput.files[0]);
            });
        });
    </script>
}
